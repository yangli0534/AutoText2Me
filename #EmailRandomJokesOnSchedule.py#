# -*- coding:gb2312 -*-
__author__ = '‘Àî‘Ñó'

'''
    Author : Leon
    Email  : yangli0534@yahoo.com
    Description: 1 grab a joke from the Internet 
                 2 email to someone on schedule 
'''
import smtplib
from email.MIMEMultipart import MIMEMultipart
from email.MIMEText import MIMEText
import urllib2
import re
import schedule
import time
import datetime

class randomJoke:

    #‘³õ‘Ê¼‘»¯‘·½‘·¨
    def __init__(self):
        self.url = 'http://lengxiaohua.com/random'
        self.user_agent = 'Mozilla/4.0 (compatible; MSIE 5.5; Windows NT)'
        #‘³õ‘Ê¼‘»¯headers
        self.headers = { 'User-Agent' : self.user_agent }
        #‘Ð¦‘»°‘ÄÚ‘ÈÝ
        self.content = []

    #‘»ñ‘È¡‘Íø‘Ò³‘Ô´‘´ú‘Âë
    def getSourceCode(self):
        try:
            request = urllib2.Request(url = self.url, headers=self.headers)
            response = urllib2.urlopen(request)
            sourceCode = response.read().decode('utf-8')
            return sourceCode
        except urllib2.URLError, e:
            if hasattr(e,"reason"):
                print u"‘Íø‘Âç‘´í‘Îó...",e.reason
                return None

    #‘»ñ‘È¡‘Ð¦‘»°
    def setContent(self):
        sourceCode = self.getSourceCode()
        if not sourceCode:
            print('‘»ñ‘È¡‘Íø‘Ò³‘ÄÚ‘ÈÝ‘Ê§‘°Ü~‘£¡')
            quit()
        pattern = re.compile(' <pre.*?js="joke_summary".*?"first_char">(.*?)</span>(.*?)</pre>.*?class="user_info">.*?<a.*?>(.*?)</a>.*?(.*?)',re.S)
        items = re.findall(pattern,sourceCode)
        self.content = items
        #print u"‘ÒÑ‘¾­‘ÅÀ‘È¡‘Ô´‘´ú‘Âë...‘Õý‘ÔÚ‘½â‘Îö‘Ô´‘´ú‘Âë..."

    #‘·µ‘»Ø‘Ð¦‘»°
    def getContent(self):
        return self.content

    #‘´ò‘Ó¡‘Ò»‘Ôò‘Ð¦‘»°
    def printAJoke(self,number):
        joke = self.content[number]
        print u"‘×÷‘Õß:%s" %(joke[2])
        print u'‘·¢‘±í‘ÓÚ:'+ joke[3]
        #item[0]‘ºÍitem[1]‘×é‘³É‘Íê‘Õû‘µÄ‘ÄÚ‘ÈÝ
        print joke[0]+joke[1]

    def getAJoke(self,number):
        joke = self.content[number]
        content = ""
        #content = content+ u"‘×÷‘Õß:" %(joke[2])
        #print u'‘·¢‘±í‘ÓÚ:'+ joke[3]
        #item[0]‘ºÍitem[1]‘×é‘³É‘Íê‘Õû‘µÄ‘ÄÚ‘ÈÝ
        content =  joke[0]+joke[1]
        return content

def job():
    global myRandomJoke
    #global server
    global toaddr
    global fromaddr
    global password
    t = datetime.datetime.now()
    content = ""
    content = content+ u"‘Äã‘ºÃ‘£¬‘Õâ‘Àï‘ÊÇ‘Ëæ‘»ú‘Ð¦‘»°‘£¡"
    content = content+ "It's "
    content = content+ t.strftime("%A, %d. %B %Y %I:%M%p")
    myRandomJoke.setContent()
    #myRandomJoke.printAJoke(2)
    content = content + myRandomJoke.getAJoke(2)
    print content
    

    msg = MIMEMultipart()
    msg['From'] = fromaddr
    msg['To'] = toaddr
    msg['Subject'] = "Leon send a joke for u on"+t.strftime("%A, %d. %B %Y %I:%M%p")

    try:
        body = "YOUR MESSAGE HERE"
        msg.attach(MIMEText(content, 'plain'))
        text = msg.as_string()
        server = smtplib.SMTP_SSL("smtp.qq.com", 465)# connect to email server
        server.login(fromaddr,password)
        server.sendmail(fromaddr, toaddr, text)
        server.quit()
        print "send email successfully"
    except:
        print "failed!"

toaddr = "yangli0534@yahoo.com" # email address to send
password = "gomdocpagqgecbag" # email password 
fromaddr = "502327976@qq.com"# my email address
#server = smtplib.SMTP('smtp.yahoo.com', 587, None, 30)
#server = smtplib.SMTP_SSL('smtp.googlemail.com', 465)
#server = smtplib.SMTP_SSL("smtp.qq.com", 465)# connect to email server

myRandomJoke = randomJoke()
job()
schedule.every(2).minutes.do(job)
#notQuit = True
#print u"‘Äã‘ºÃ‘£¬‘Õâ‘Àï‘ÊÇ‘Ëæ‘»ú‘Ð¦‘»°‘£¡"
while True:
    schedule.run_pending()
    time.sleep(10)
    
#print u"---------------------"
#randomJoke.setContent()
#print u"...."
#print u"‘Ð¦‘»°‘³Ø‘ÒÑ‘¾­‘×°‘Âú‘£¬20/20"
#print u"‘Êä‘Èë1‘µ½20‘¿´‘Ð¦‘»°~~‘£¬‘Êä‘Èëquit‘ÍË‘³ö,‘Êä‘Èënew‘ÖØ‘ÐÂ‘ÅÀ‘È¡‘ÐÂ‘Ð¦‘»°"
#while notQuit:
#    input = raw_input()
#    if input == "quit" :
#        print u"bye‘£¡"
#        notQuit = False
#    elif input == "new":
#        randomJoke.setContent()  #‘ÖØ‘ÐÂ‘×¥‘È¡‘Ð¦‘»°‘ÄÚ‘ÈÝ
#        print u"...."
#        print u"‘Ð¦‘»°‘³Ø‘ÒÑ‘¾­‘×°‘Âú‘£¬20/20"
#        print u"‘Êä‘Èë1‘µ½20‘¿´‘Ð¦‘»°~~‘£¬‘Êä‘Èëquit‘ÍË‘³ö,‘Êä‘Èënew‘ÖØ‘ÐÂ‘ÅÀ‘È¡‘ÐÂ‘Ð¦‘»°"
#    else:
#        input = int(input)
#        randomJoke.printAJoke(input-1)
#        print u"--------------------------------------------------"
#        print u"‘Êä‘Èë1‘µ½20‘¿´‘Ð¦‘»°~~‘£¬‘Êä‘Èëquit‘ÍË‘³ö,‘Êä‘Èënew‘ÖØ‘ÐÂ‘ÅÀ‘È¡‘ÐÂ‘Ð¦‘»°"
#print u"‘Äú‘ÒÑ‘¾­‘³É‘¹¦‘ÍË‘³ö‘£¡"


#quit()
